---
plan_id: preserve-plan-output-files
status: done
evaluation_notes: []
git_sha: e39e717d808b8cc78e913a819316d84b2c64956a
---

## Objectives

Resolve the issue where plan files generated by Claude Code (or Droid) in a temporary worktree are lost when the worktree is forcefully removed. Plan output files written to `.lw_coder/tasks/` should be preserved in the main repository.

## Requirements & Constraints

### Functional Requirements
- **Copy newly created plan files**: After the executor finishes but before the worktree is removed, copy all newly created files from the worktree's `.lw_coder/tasks/` to the main repository's `.lw_coder/tasks/`
- **Track pre-existing files**: Distinguish between files that existed before the plan command started and files created during execution
- **Conflict resolution**: Use Chrome-style numbering for naming conflicts (e.g., `my-plan.md`, `my-plan (1).md`, `my-plan (2).md`)
- **Verbose logging**: Log all file copy operations to inform users of actual output locations when numbering occurs

### Non-Functional Requirements
- **Minimal code changes**: Integrate the solution into the existing `plan_command.py` workflow with minimal disruption
- **Performance**: File copying should be fast (typically a few KB of markdown files)
- **Error handling**: Failed file copies should not block worktree cleanup; log warnings instead

### Constraints
- Only copy newly created files (not pre-existing files that may have been modified in the worktree)
- File copying happens in the main repository's working directory context, not the worktree
- Must not interfere with the existing cleanup logic in the finally block

## Work Items

### 1. Create file tracking utility module
**File**: `src/lw_coder/plan_file_copier.py`
- Implement `get_existing_files(tasks_dir: Path) -> Set[str]` to capture file names before execution
- Implement `find_new_files(tasks_dir: Path, existing_files: Set[str]) -> List[Path]` to identify newly created files
- Implement `generate_unique_filename(target_dir: Path, filename: str) -> str` to apply Chrome-style numbering when conflicts occur
- Implement `copy_plan_files(source_dir: Path, dest_dir: Path, existing_files: Set[str]) -> Dict[str, str]` that:
  - Finds newly created files in source directory
  - Copies each file to destination with conflict resolution
  - Returns mapping of original -> final filenames
  - Raises `PlanFileCopyError` on critical failures (directory doesn't exist, permission denied)

### 2. Integrate file copying into plan_command workflow
**File**: `src/lw_coder/plan_command.py`
- Before creating the executor, capture existing files: `existing_files = get_existing_files(worktree_tasks_dir)`
- After executor completes successfully (line ~228), call copy logic before worktree cleanup
- Add logging for each copied file with original and final filenames
- Handle `PlanFileCopyError` gracefully with warning logs (don't fail the entire plan command)

### 3. Add exception class
**File**: `src/lw_coder/plan_command.py` or new module
- Create `PlanFileCopyError` exception class for file copy operations

### 4. Update tests
**File**: `tests/test_plan_command.py`
- Add unit tests for `plan_file_copier.py` functions:
  - Test `generate_unique_filename` with various conflict scenarios
  - Test `find_new_files` correctly identifies only new files
  - Test `copy_plan_files` with various file structures
- Add integration test verifying plan files are copied and renamed correctly when conflicts occur

## Deliverables

1. `src/lw_coder/plan_file_copier.py` - Complete file copying module with all helper functions
2. Updated `src/lw_coder/plan_command.py` - Integrated file copying into the plan command workflow
3. Updated `tests/test_plan_command.py` - Comprehensive test coverage for new functionality
4. All tests pass: `uv run pytest`
5. Verified that plan files are preserved with correct naming when running the plan command

## Out of Scope

- Modifying the executor implementations (Claude Code, Droid, etc.)
- Changing worktree creation or removal logic
- Implementing file versioning or archival of old plans
- UI/UX changes to the CLI output beyond logging

## Test Cases

```gherkin
Feature: Preserve Plan Output Files from Temporary Worktree
  Scenario: Single plan file is copied successfully
    Given a temporary worktree with .lw_coder/tasks/ directory
    And the main repository has an empty .lw_coder/tasks/ directory
    When a plan file "my-feature.md" is created in the worktree's .lw_coder/tasks/
    And the plan command copy logic is executed
    Then the file "my-feature.md" should exist in the main repository's .lw_coder/tasks/
    And the log should contain "Saved plan to .lw_coder/tasks/my-feature.md"

  Scenario: File naming conflict is resolved with numbering
    Given the main repository has an existing file "my-feature.md" in .lw_coder/tasks/
    And a temporary worktree with .lw_coder/tasks/ directory
    When a new plan file "my-feature.md" is created in the worktree's .lw_coder/tasks/
    And the plan command copy logic is executed
    Then the file should be saved as "my-feature (1).md" in the main repository
    And the log should contain "Saved plan to .lw_coder/tasks/my-feature (1).md (original name my-feature.md already existed)"

  Scenario: Multiple conflicts are numbered sequentially
    Given the main repository already has "my-feature.md" and "my-feature (1).md"
    And a temporary worktree with a new "my-feature.md" file
    When the plan command copy logic is executed
    Then the file should be saved as "my-feature (2).md"
    And the log shows the rename notification

  Scenario: Pre-existing files in worktree are not copied
    Given the main repository has an existing file "old-plan.md" in .lw_coder/tasks/
    And the temporary worktree was created with this same file present
    When only a new file "new-plan.md" is created in the worktree
    And the plan command copy logic is executed
    Then only "new-plan.md" is copied to the main repository
    And "old-plan.md" is not affected

  Scenario: Multiple new plan files are copied and numbered correctly
    Given a temporary worktree creates two plan files: "feature-a.md" and "feature-b.md"
    And the main repository already has "feature-a.md"
    When the plan command copy logic is executed
    Then "feature-a (1).md" and "feature-b.md" are created in the main repository
    And both operations are logged with their final names

  Scenario: Copy failure does not prevent worktree cleanup
    Given a read-only .lw_coder/tasks/ directory in the main repository
    When the plan command tries to copy files and encounters a permission error
    Then a warning is logged about the failed copy
    And the plan command still exits normally after cleaning up the worktree
    And the return code indicates partial success/warning
```
